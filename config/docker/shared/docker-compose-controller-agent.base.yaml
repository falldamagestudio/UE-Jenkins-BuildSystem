services:
  controller-agent:
    image: linux-swarm-agent:local

    container_name: controller-agent

    volumes:
      # Ensure the controller agent's home directory maps to a Docker volume
      # This allows upgrading the agent container but keeping workspace
      - type: volume
        source: controller-agent-home
        target: /home/jenkins

      # Make GCP Service Account credential file available to controller agent
      - type: bind
        source: ./google_application_credentials.json
        target: /google_application_credentials.json
        bind:
          propagation: rprivate
          create_host_path: false
        read_only: true

    environment:
      JENKINS_URL: http://controller:8080
      AGENT_NAME: controller-agent
      LABELS: "controller-agent"
      GOOGLE_APPLICATION_CREDENTIALS: /google_application_credentials.json

    networks:
      - controller-vm

volumes:
  controller-agent-home:
    name: controller-agent-home

networks:
  controller-vm:
    external: true
    name: controller-vm
